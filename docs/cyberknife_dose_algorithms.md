# CyberKnife 線量計算アルゴリズム概要

ShioRIS3 の `CyberKnifeDoseCalculator` は、点線量計算に基づくボリューム線量合成を段階的に行うアーキテクチャになっています。本書では `src/cyberknife/dose_calculator.cpp` の実装をもとに、アルゴリズムの種類と役割を整理します。

## 1. 基本線量計算（点線量評価）
- **点線量計算 (`calculatePointDose`)**: ビームコリメータサイズ、深度、軸外距離に応じて、ビームデータベースから取得した Output Factor・OCR・TMR を組み合わせ、局所密度スケーリングとともに基準線量を算出します。
- **基準データソース**: `BeamDataManager` に読み込まれた DMTable/OCRtable/TMRtable を補間して係数を取得します。

## 2. ボリューム線量計算（単一ビーム）
- **ボクセル並列処理 (`VolumeProcessor::processVolumeParallel`)**: QtConcurrent を使用してスライスごとに並列処理し、全ボクセルの線量計算を行います。
- **HU 密度変換 (`HounsfieldConverter`)**: CT の HU 値を実密度に変換し、点線量計算の密度補正や散乱・減衰係数の推定に用います。
- **散乱線補正 (`ScatterCalculator`)**: 3×3×3 の近傍ボクセル密度から散乱寄与係数を求め、最大 ±10% の補正を適用します。
- **深度減衰補正**: ビーム経路上の深度に基づき指数関数的な減衰係数を適用し、局所密度に応じた減衰を再現します。
- **ビーム硬化補正 (`BeamPathAccumulator`)**: ビーム源からボクセルまでの経路密度を積分し、平均密度に応じた硬化補正（±15% を上限）を掛け合わせます。
- **プログレス通知**: 並列処理中にボクセル進捗率を逐次更新し、コールバックに 0〜100% を通知します。

## 3. 複数ビーム合成
- **ビーム重み付け (`calculateMultiBeamVolumeDose`)**: 各ビームごとに単一ビーム計算を実施し、指定された重みに従って線量を加算します。重みが未指定の場合は等重みで合成します。
- **異なるアイソセンターへの対応**: 各ビームのジオメトリを独立して評価するため、異なるアイソセンターでもボクセル座標ごとに正しく線量を加算できます。

## 4. エラーハンドリングとメモリ管理
- **入力検証**: CT ボリューム寸法やデータ存在チェックを行い、不整合時には詳細なエラーを返します。
- **メモリ確保の例外処理**: OpenCV の `cv::Exception` と `std::bad_alloc` を捕捉し、メモリ不足をユーザーへ通知します。
- **最大線量更新**: 計算完了後に `cv::minMaxIdx` で最大線量を抽出し、RTDoseVolume のメタ情報に設定します。

これらの段階的な補正と合成により、ShioRIS3 は CyberKnife 用のボリューム線量を高精度かつ並列に算出します。
